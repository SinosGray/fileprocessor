---
categories:
- 私密
date: 2021-01-14 16:16:48
password: wzqdiary
tags:
- '255'
- module
- cstring
- loadstring
- ids
title: 视频剪辑
---

>简介

<!--more-->

剪辑路径

![image-20210905150212509](../../../008i3skNgy1gu5ribb32kj60pg0coaca02.jpg)

# 视频剪辑

![截屏2020-07-09 下午10.15.16](https://tva1.sinaimg.cn/large/007S8ZIlly1ggl2x1dlatj31e20cagn1.jpg)

> replay/replaypanedlg.cpp
>
> OnEdit(  )
>
> cumodel/videoreplaymodel.cpp
>
> StartEditVideo(  )
>
> Replay\PlaybackManager.cpp
>
> EditVideo(listItem, bStart)
>
> cumodel/replay/videoreplaycontrol.cpp
>
> StartEditVideo(id)
>
> StopEditVideo()

## 函数解析

### cumodel/replay/videoreplaycontrol.cpp

#### StartEditVideo(id)

- 流程
  - 确认 id
  - 创建文件
  - avstream
  - 发送剪辑变化消息
  - 连接模型

#### StopEditVideo()

- 流程
  - 发送剪辑变化消息
  - 连接模型

### Replay\PlaybackManager.cpp

#### EditVideo(listItem, bStart)

- 流程 
  - 启动剪辑或者停止剪辑(bstart = true or false)

### cumodel/videoreplaymodel.cpp

#### StartEditVideo()

- 流程
  - 发送消息 notify eReplayStartEditVideo

#### StopEditVideo()

- 流程
  - 发送消息 notify eReplayStopEditVideo

### replay/replaypanedlg.cpp

#### OnEdit()

- 流程
  - 调用 videoreplaymodel 的 start 和 stop

# 视频下载

> replay/loadFileDlg.cpp
>
> replay/replaypanedlg.cpp
>
> OnEdit(  )

## 函数解析

### replay/loadFileDlg.cpp

#### StartLoad()

## 更改

### OnEdit(  )

```cpp
void CReplayPaneDlg::OnEdit()
{
	IVideoReplayModel *pModel  = GetInlPtr<IVideoReplayModel*>(_T("VideoReplayModel"));
	if (NULL==pModel)
	{
		return;
	}

	if (m_bPlaying)
	{
		if (m_bEdit)
		{
			BEGIN_MODULE_RESOURCE
			CString str;
			str.LoadString(IDS_EDIT_START);
			
			m_btn_edit.SetTooltipText(str);
			m_bEdit=false;
			m_btn_edit.SetBitmapsEx(IDB_BIT_EDIT, RGB(255,255,255), IDB_BIT_EDIT_FOCUS,RGB(255,255,255),IDB_BIT_EDIT_PRESSED, RGB(255,255,255));
			END_MODULE_RESOURCE
			// 发送消息到 回放主界面，隐藏剪辑磁盘的显示信息
			//::SendMessage(GetParent()->GetParent()->GetSafeHwnd(),WM_REPLAY_REFRESH_STATUS,1,0);
			if (!(::IsWindow(m_loadFileDlg.GetSafeHwnd())))
			{// 之前没有下载进程
				BEGIN_MODULE_RESOURCE
					m_loadFileDlg.CreateWnd(CLoadFileDlg::IDD, this);
				END_MODULE_RESOURCE
				m_loadFileDlg.CenterWindow(this);
				if (m_loadFileDlg.InitLoadfileDlg()==FALSE)
				{
					CString str,strTips;
					BEGIN_MODULE_RESOURCE
						strTips.LoadString(IDS_TIPS);
					str.LoadString(IDS_SEARCH_FIRST);
					END_MODULE_RESOURCE
						CenterMessageBox(CReplayUI::replayUI, str, strTips, MB_OK|MB_ICONINFORMATION);

					m_loadFileDlg.DestroyWindow();
				}
				else
				{
					
					m_loadFileDlg.ShowWindow(SW_SHOW);
				}
				
			}
			else
				m_loadFileDlg.ShowWindow(SW_SHOW);

		}
		else
		{
			//pModel->StartEditVideo();
			BEGIN_MODULE_RESOURCE
				CString str;
			str.LoadString(IDS_EDIT_ING);
			
				m_btn_edit.SetTooltipText(str);
			m_bEdit=true;
			m_btn_edit.SetBitmapsEx(IDB_BIT_EDIT_END, RGB(255,255,255), IDB_BIT_EDIT_END_FOCUS,RGB(255,255,255),IDB_BIT_EDIT_END_PRESSED, RGB(255,255,255));
			END_MODULE_RESOURCE
		}
	}
	else
	{// 回放尚未启动，暂时不能剪辑
		BEGIN_MODULE_RESOURCE
			CString strTips,str;
		strTips.LoadString(IDS_TIPS);
		str.LoadString(IDS_NOVIDEO_EDIT);
		END_MODULE_RESOURCE
			//MessageBox(str, strTips, MB_OK|MB_ICONINFORMATION);
			CenterMessageBox(CReplayUI::replayUI, str, strTips, MB_OK|MB_ICONINFORMATION);

	}
}
```

### Replay\LoadFileDlg.h+ReplayPaneDlg.h

```cpp
public:
	bool        m_bEdit;
	SDPTIME  m_start, m_end;
```

### replay/loadFileDlg.cpp

```cpp
int CLoadFileDlg::StartLoad()
{
	ENEAVCODEProtocol codec=ENEAVCODEProtocol_AVI;
	if (!m_bLoading)
	{
		// 检测盘符是否有效
		CString strPath;
		CString cfgPath=Environment::GetConfigPath();
		cfgPath.Append(_T("\\"));
		cfgPath.Append(_T("Config.ini"));
		//打开INI文件
		INIFile file(cfgPath);
		if (m_bEdit)
		{
			file.ReadPair(Environment::ProjectName,_T("EditPath"),strPath);//来自videoreplaycontrol
		}
		else {
			file.ReadPair(Environment::ProjectName,_T("DownloadFolder"),strPath);
		}
		if (!CUHelper::IsValidDiskPath(strPath))
		{
			BEGIN_MODULE_RESOURCE
				CString str,strTips;
			strTips.LoadString(IDS_TIPS);
			str.LoadString(IDS_UNVALID_LOAD_PATH);
			END_MODULE_RESOURCE
				//MessageBox(str,strTips, MB_OK|MB_ICONINFORMATION);
				CenterMessageBox(this, str, strTips, MB_OK|MB_ICONERROR);
			return 1;
		}

		SYSTEMTIME tm_start, tm_end;
		if (m_bEdit)
		{
			//TODO: 设置时间
			m_ctrl_start_time.SetTime(&tm_start);
			m_ctrl_end_time.SetTime(&tm_end);
		}
		else {
			m_ctrl_start_time.GetTime(&tm_start);
			m_ctrl_end_time.GetTime(&tm_end);
		}
		SDPTIME begin,end;
		begin = m_condition.begin+(tm_start.wHour*3600+tm_start.wMinute*60+tm_start.wSecond)*1000;
		end   = m_condition.begin +(tm_end.wHour*3600+tm_end.wMinute*60+tm_end.wSecond)*1000;
		if (begin >= end)
		{
			BEGIN_MODULE_RESOURCE
				CString str,strTips;
			str.LoadString(IDS_UNVALID_TIME_SNAP);
			strTips.LoadString(IDS_TIPS);
			END_MODULE_RESOURCE
				//MessageBox(str,strTips, MB_OK|MB_ICONINFORMATION);
				CenterMessageBox(this, str, strTips, MB_OK|MB_ICONINFORMATION);
			m_bEdit = false;
			return 1;
		}

		int nIndex = m_comChannel.GetCurSel();
		std::map<UINT,CString>::iterator tmp = m_chList.find(nIndex);
		if (tmp == m_chList.end())
		{
			DEBUGINFO(DEBUG_ERROR, _T("[liy]--LoadFile 没有选择有效的通道"));
			m_bEdit = false;
			return 1 ;
		}

		IVideoDownloadModel *pModel = GetInlPtr<IVideoDownloadModel*>(_T("VideoDownloadModel"));
		if (pModel)
		{
			m_listDetail.DeleteAllItems();
			int ret = pModel->AddDownloadTask(tmp->second, begin, end,codec);
			if (ret==0)
			{
				m_bLoading = true;
				m_strLoading = tmp->second;
				DEBUGINFO(DEBUG_TIPS, _T("正在解析下载录像文件信息.....\n"));
				BEGIN_MODULE_RESOURCE
					CString str;
				str.LoadString(IDS_LOAD_PARSING);
				END_MODULE_RESOURCE
				m_static_percent.SetWindowText(str);		

				 // 转移焦点
				GetDlgItem(IDC_PB_LOAD_BK)->SetFocus();

				// 在回放主界面状态栏显示磁盘信息
				::PostMessage(m_hParent, WM_REPLAY_REFRESH_STATUS, 0, 1);

				m_bDiskOver=false;
				m_bDiskAbnormal=false;
				m_bEdit = false;
				
			}
			else
			{
				DEBUGINFO(DEBUG_ERROR, _T("[liy]--AddDownloadTask Interface Failed..\n"));
				m_bEdit = false;
				return 1;
			}
		}

		

		BEGIN_MODULE_RESOURCE
//			m_suspendWnd.Create(CFloatWnd::IDD,	this);
//			m_suspendWnd.OnUpdateTransparent(255);
//			m_suspendWnd.ShowWindow(SW_SHOW);
			CString str;
			str.LoadString(IDS_STOP_LOADING);
			m_btn_load.SetWindowText(str);

		//	CWnd wnd;
		//	wnd.Attach(::GetDesktopWindow());
		//	m_suspendWnd = new CFloatWnd(&wnd);
		//	m_suspendWnd->SetParentWnd(this);//设置下载的主窗口，GetParent()函数获取的父窗口已被设置为桌面
	//		m_suspendWnd->DoModal();
	
		END_MODULE_RESOURCE

		IMitModel *mitModel  = GetInlPtr<IMitModel*>(_T("MitModel"));
		CString strChannelName;			
		if (mitModel)
		{
			MitObjInfo info;
			bool ret = mitModel->GetMitObjInfo(tmp->second, info);
			if (ret)
			{
				strChannelName = info.fullname;				
			}

			CString strParent;
			mitModel->GetMitParent(tmp->second, strParent);
			mitModel->GetMitObjInfo(strParent, info);
			if (m_suspendWnd==NULL)
			{
				BEGIN_MODULE_RESOURCE
				m_suspendWnd = new CFloatWnd;
				m_suspendWnd->Create(CFloatWnd::IDD, this);
				m_suspendWnd->SetParentWnd(this);//设置下载的主窗口，GetParent()函数获取的父窗口已被设置为桌面
				m_suspendWnd->ShowWindow(SW_SHOW);
				END_MODULE_RESOURCE
			}
		}

		if (m_suspendWnd)
			m_suspendWnd->SetChannelName(strChannelName);
		

	}
	m_bEdit = false;
	return 0;
}

```

### RightDlg.h

```cpp
public:
  SDPTIME cur_time;
```

### RightDlg.cpp

```cpp
CRightDlg::OnResultTableDLClick(WPARAM wParam, LPARAM lParam)
  cur_time=data->time;
```





## 修改思路

判断是否在剪辑(m_Playing), 

## nvr 与 cvr

https://zhuanlan.zhihu.com/p/67217451

## 其他

avstream https://blog.csdn.net/kenn1117/article/details/71173246





cscreenwnd hittestitem

replay.manager.hittestitemget

```cpp
CString s;
s.Format("%d", m_loadFileDlg.m_Index);
AfxMessageBox(s);
```





















